Launching a team server
The team server and client are installed with Cobalt Strike by default. However, you'll need to start the team server before you can use the client. First, navigate to the Cobalt Strike directory. In this lab, we've installed Cobalt Strike in the /opt/cobaltstrike directory.

linux@cobaltstrike-teamserver:~$ cd /opt/cobaltstrike
Mandatory arguments
Conveniently, Cobalt Strike comes bundled with a pre-configured script to start the team server. When launching the team server, two mandatory arguments are required:

ip_address  – the externally accessible IP address of the team server.

password – the password to connect to the team server. 

In addition, root privileges are required to start the team server. Therefore, the script must either be run as the root user or by using sudo.

Optional arguments
Additionally, the team server script takes two optional arguments, malleableC2profile and kill_date. The first (malleableC2profile) argument launches the team server with a specific C2 profile, customizing the behavior of Cobalt Strike using malleable C2 profiles. 

The second (kill_date) argument is used to designate a date where all activity should be stopped, forcing all connections to close, and preventing any further activity using Cobalt Strike. However, in this series, you won't be required to use either of these optional arguments.

Example
So, if our team server was hosted on a device with the IP address 10.10.1.120, and we wanted to start it with the password SuperStrongSecretPassword, we would run the following:

linux@cobaltstrike-teamserver:/opt/cobaltstrike$ sudo ./teamserver 10.10.1.120 SuperStrongSecretPassword
Once the team server has been launched, a SHA256 hash is generated. This is the hash of the team server's SSL certificate and should be unique to each team server. This hash can be shared with red team operators so that they know they're connecting to the correct team server, reducing the risk of man-in-the-middle attacks.

linux@cobaltstrike-teamserver:/opt/cobaltstrike$ sudo ./teamserver 10.10.1.120 SuperStrongSecretPassword
[*] Will use existing X509 certificate and keystore (for SSL)
[+] Team server is up on 0.0.0.0:50050
[*] SHA256 hash of SSL cert is: 60da90152d3dd96efd96622b51416f359dfe6f054ec85ec0505aeedb4076496b
Connecting to a teamserver using the client
When first launched, Cobalt Strike will create the .aggressor.prop file in your user directory (%USERPROFILE% for Windows users or /home/yourusername for Linux), containing properties for the Cobalt Strike client. Cobalt Strike also uses this file to store the connection details for team servers, added via the Connect dialog box that opens on launch. Note that due to the . prefix, this file is automatically hidden on Linux.

Open the Cobalt Strike client by double-clicking on the Cobalt Strike icon on the desktop. Alternatively, open a terminal from the desktop and navigate to the /opt/cobaltstrike directory, then run the cobaltstrike script. 

To connect to a team server, you'll need to provide the following:

Alias: A "friendly" name for the connection. This can be anything.
IP address: The externally accessible IP address of the team server. This must match the IP address used when launching the team server.
Port: The port the team server is running on. Team servers run on port 50050 by default.
User: The username to connect to the team server with.
Password: The password of the team server. This is the password you specified when launching the team server.

Any previous connections can be re-opened by selecting the profile from the panel on the left side of the dialog box. By default, profiles are listed using the connection's Alias Name. Selecting the Host Names button instead will display the host name of the connection. Click Connect to start connecting to the team server.

When an operator attempts to connect to the server for the first time, they'll be required to verify the SHA256 hash of the team server. This will confirm that they're connecting to the expected team server. 


If the server fingerprint matches the SHA256 generated by the team server on launch, the operator can be confident that they're connecting to the correct server. Selecting Yes on the dialog box will establish the connection and the Cobalt Strike client will open. 

When the SHA256 hash is accepted for the first time, it's added to the user's .aggressor.prop file and associated with the team server connection as a trusted fingerprint. Subsequent connections to the same team server will not require verification of the same SHA256 hash.

Cobalt Strike interface
The Cobalt Strike interface is split into two horizontal panels: the top half of the client is used to visualize any sessions or targets and the bottom is reserved for interacting with sessions or using Cobalt Strike features. 


The Cobalt Strike toolbar (at the top of the client) provides quick access to some of Cobalt Strike's main features. When you first open Cobalt Strike, you'll be presented with the Event Log – a key feature. With this, operators connected to the team server can communicate with each other (IRC-style) or receive event notifications from Cobalt Strike.
-----------
Cobalt Strike's Beacon
More often than not, you'll configure a listener with Cobalt Strike's Beacon payload. Beacon is Cobalt Strike's default payload to model advanced threats and is primarily used to egress a network over network protocols such as DNS and HTTP. However, peer-to-peer communication is also possible with TCP sockets or SMB named pipes.

Beacon DNS
The Beacon DNS listener uses the DNS protocol to establish communication between the compromised device and the team server. DNS Beacons establish sessions with a team server using DNS requests for domains that your Cobalt Strike team server is authoritative for. 

Depending on the DNS response, Beacon will either sleep or connect to the team server and download tasks. Beacon can download tasks over TXT records, AAAA records, or A records, and can change between these record types at ease.

HTTP(S) Beacon
Both the Beacon HTTP and Beacon HTTPS listeners download tasks with an HTTP GET request, sending data back with an HTTP POST request as the default. This behavior can be modified through the use of malleable C2 profiles, allowing red team operators to customize the network signatures, behavior, and indicators of HTTP(S) Beacons.

Child Beacons
With Cobalt Strike, it's possible to use one Beacon to spawn from and communicate through another. When two Beacons are linked in this way, the child Beacon will get tasks and send its output via the parent Beacon. SMB and TCP Beacons are two listener types that are typically spawned as child Beacons. SMB Beacon uses named pipes to communicate, whereas TCP Beacon uses a TCP socket to communicate through a parent Beacon. 

This adds a degree of stealth to the Cobalt Strike engagement, preventing too many egress network connections from Beacons. In the example below, an enterprise network might monitor egress network connections (highlighted in blue), but peer-to-peer connections (highlighted in red) may not be as scrutinized. 


Child Beacons can also be spawned on devices where egress network connections are restricted, or blocked entirely. Using the parent Beacon as the pivot point, the Cobalt Strike operator can target devices that are typically only used for internal network connections.


Managing listeners
Listeners are created and managed using the Cobalt Strike client. To create a listener, open Cobalt Strike, then connect to a running team server. 

Open the Listeners panel by clicking on the headphones icon in the toolbar, or opening the Cobalt Strike menu (located above the toolbar) and selecting the Listeners option.


Select Add to open the New Listener configuration window and create a new listener.


Configuring a listener
First, each listener needs a unique name – this will be used throughout the Cobalt Strike engagement to refer to the listener. Next, select the type of listener you're creating from the Payload drop-down box. 

Depending on the listener type, a range of payload options may also need to be configured. For example, HTTP Beacons require you to specify the HTTP Host to use with the payload (in this example, the IP address of the team server), while SMB Beacons allow you to specify the pipe name to use for communication, or use the default pipe name.

Click the Save button to finish the listener creation process. Once saved, Cobalt Strike will display a confirmation pop-up message:


In the Listeners tab, you should see the details of the listener that's now running.


Interacting with listeners
The interaction options for listeners can be found at the bottom of the Listener tab. To edit the details of a listener, select it and click Edit. To remove a listener, select it and click Remove. 

